---
layout: default
title: KEICHA 抹茶代購商店
description: 一保堂 中村藤吉 山政小山園 代購台灣 | KEICHA
keywords: 抹茶代購, 抹茶, 丸久小山園, 山政小山園, 星野製茶園, 上林春松本店, 台灣, 日本抹茶, 一保堂
---

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />

<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    brand: '#6ea44c',
                    brandLight: '#ebf1e9',
                    brandDark: '#5d8d41',
                    brandBg: 'rgba(110,164,76,0.1)',
                },
                fontFamily: {
                    sans: ['Noto Sans TC', 'sans-serif'],
                    brand: ['Zen Maru Gothic', 'sans-serif'],
                },
                boxShadow: {
                    'panel': '-4px 0 25px rgba(0,0,0,0.15)',
                    'sticky': '0 -4px 10px rgba(0,0,0,0.05)',
                }
            }
        }
    }
</script>

<style>
    :root { --font-brand: "Zen Maru Gothic", sans-serif; }
    /* 修正 body 為 wrapper，避免影響全站樣式 */
    .shop-wrapper { font-family: "Noto Sans TC", sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 100px; background-color: #ffffff; overflow-x: hidden; position: relative; }
    .font-brand-text { font-family: var(--font-brand); font-weight: 700; }
    .loader { border: 2px solid #f3f3f3; border-top: 2px solid #6ea44c; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Side Panel 樣式保留，Z-index 設高以覆蓋全站 Header */
    .side-panel { position: fixed; top: 0; right: 0; bottom: 0; width: 100%; max-width: 420px; background: white; z-index: 200; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: var(--shadow-panel); display: flex; flex-direction: column; }
    .side-panel.open { transform: translateX(0) !important; }
    
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 150; opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(2px); }
    .overlay.open { opacity: 1; visibility: visible; }
    
    .input-ui { width: 100%; padding: 12px 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 15px; outline: none; transition: all 0.2s ease; background-color: #f8fafc; color: #334155; }
    .input-ui:focus { border-color: #6ea44c; background-color: white; ring: 1px solid #6ea44c; }
    .input-ui::placeholder { color: #94a3b8; }
    
    .logistics-card { border: 1px solid #e2e8f0; border-radius: 12px; transition: all 0.2s ease; background: white; overflow: hidden; position: relative; }
    .logistics-card.active { border-color: #6ea44c; background-color: #fcfdfc; box-shadow: 0 0 0 1px #6ea44c inset; }
    .logistics-card:active { transform: scale(0.99); }
    
    .btn-query-store { background-color: white; color: #6ea44c; border: 1px solid #6ea44c; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 13px; transition: background 0.2s; text-decoration: none; white-space: nowrap; }
    .btn-query-store:hover { background-color: #e8f5e9; }
    
    .panel-footer { background: white; padding: 16px 20px; border-top: 1px solid #f1f5f9; box-shadow: var(--shadow-sticky); z-index: 20; padding-bottom: calc(env(safe-area-inset-bottom) + 24px); }
    
    .card-img-group { width: 100px; height: 100px; flex-shrink: 0; border-radius: 12px; overflow: hidden; background-color: #f9fafb; }
    @media (min-width: 768px) { .card-img-group { width: 100%; height: auto; aspect-ratio: 1/1; } }
</style>

<div class="shop-wrapper text-gray-800">

    <div id="overlay" class="overlay" onclick="closeAllPanels()"></div>

<div class="relative bg-white border-b border-gray-100 shadow-sm mb-6">
  <div class="container mx-auto px-4 max-w-5xl py-4 flex justify-between items-center">
    
    <!-- 左側區塊：商店名稱 + 促銷文案 -->
    <div class="flex flex-col">
      <h1 class="text-xl font-bold tracking-tight text-brand flex items-center gap-2">
        <span class="font-brand-text text-2xl">抹茶代購網路商店</span>
      </h1>
      
      <!-- 促銷文案段落 -->
      <h2 class="text-sm font-semibold text-gray-800 flex items-center gap-2 mt-1">
        同品牌任選兩件，享優惠價
      </h2>
    </div>
    
    <!-- 右側購物清單按鈕 -->
    <div class="flex items-center gap-2">
      <button type="button" onclick="openCart()" 
              class="flex items-center gap-2 px-3 py-2 text-brand hover:bg-brandLight rounded-full transition cursor-pointer relative">
        
        <!-- 購物袋 ICON -->
        <span class="material-symbols-rounded text-2xl pointer-events-none">shopping_bag</span>
        
        <!-- 文字：手機隱藏，桌面顯示 -->
        <span class="font-medium hidden sm:inline">購物清單</span>
        
        <!-- 數量徽章 -->
        <span id="header-cart-badge" 
              class="absolute -top-1 -right-1 bg-brand text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full hidden pointer-events-none">
          0
        </span>
      </button>
    </div>
    
  </div>
</div>

    <section class="py-4 bg-white">
        <div class="container mx-auto px-4 max-w-5xl">
            <h2 class="text-xl font-bold text-center mb-6 text-gray-800 flex items-center justify-center gap-2">
                <span class="material-symbols-rounded text-brand">storefront</span> 品牌總覽
            </h2>
            <div id="status-loader" class="flex justify-center h-20 items-center">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10"></div>
            </div>
            <div id="status-grid-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </section>

    <main class="max-w-5xl mx-auto px-4 py-8 pb-32">
        <div id="product-list-container" class="space-y-12"></div>
    </main>

    <div id="cart-sidebar" class="side-panel">
        <div class="flex flex-col h-full">
            <div class="p-5 border-b border-gray-50 flex justify-between items-center bg-white relative shrink-0">
                <div class="absolute left-0 top-1/2 -translate-y-1/2 h-6 w-1 bg-brand rounded-r"></div>
                <div class="flex items-center gap-2 text-gray-800 font-bold text-xl pl-3">
                    <span class="material-symbols-rounded text-brand">list_alt</span>
                    購物清單
                </div>
                <button onclick="closeAllPanels()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition cursor-pointer">
                    <span class="material-symbols-rounded text-2xl pointer-events-none">close</span>
                </button>
            </div>
            <div id="cart-items-wrapper" class="flex-1 overflow-y-auto p-0 pb-4"></div>
            <div class="panel-footer bg-gray-50 shrink-0">
                <div class="space-y-4">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-gray-500 font-medium text-sm">商品小計</span>
                        <span class="text-xl font-bold text-brand font-mono">NT$ <span id="cart-subtotal">0</span></span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="closeAllPanels()" class="col-span-1 bg-white text-gray-500 border border-gray-200 font-bold py-3.5 rounded-xl hover:bg-gray-50 transition flex justify-center items-center gap-2">繼續選購</button>
                        <button onclick="openCheckout()" class="col-span-1 bg-brand text-white font-bold py-3.5 rounded-xl shadow-lg shadow-brand/20 hover:bg-brandDark active:scale-[0.98] transition flex justify-center items-center gap-2">前往結帳 <span class="material-symbols-rounded text-sm">arrow_forward</span></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="checkout-panel" class="side-panel">
        <div class="flex flex-col h-full relative">
            <div class="p-5 bg-white border-b border-gray-100 flex justify-between items-center z-10 shrink-0">
                <h3 class="font-bold flex items-center gap-2 text-lg text-gray-800">
                    <span class="material-symbols-rounded text-brand">shopping_cart_checkout</span> 結帳確認
                </h3>
                <button onclick="closeAllPanels()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-600 rounded-full hover:bg-gray-100 transition"><span class="material-symbols-rounded">close</span></button>
            </div>

            <form id="order-form" onsubmit="return false;" class="flex-1 overflow-y-auto bg-white pb-40"> 
                <div class="p-5 space-y-8">
                    <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100 space-y-4">
                        <div class="bg-white rounded-xl border border-brandBg overflow-hidden">
                            <ul id="checkout-readonly-list" class="divide-y divide-brandBg bg-[rgba(110,164,76,0.05)]"></ul>
                        </div>
                    </div>

                    <section class="border-b border-gray-100 pb-6">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><span class="w-1 h-4 bg-brand rounded-full"></span> 訂購人資訊</h4>
                        <div class="mb-4">
                            <label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">手機號碼 <span class="text-brand">*</span> (輸入後按箭頭帶入資料)</label>
                            <div class="flex gap-2 relative">
                                <input type="tel" id="input-phone" class="input-ui font-bold text-lg tracking-wider" placeholder="09xxxxxxxx" maxlength="10" inputmode="tel">
                                <button type="button" onclick="lookupPhoneData(this)" class="bg-brand text-white w-14 rounded-xl flex items-center justify-center hover:bg-brandDark transition disabled:opacity-50 shrink-0 shadow-sm shadow-brand/20"><span class="material-symbols-rounded">arrow_forward</span></button>
                            </div>
                            <p id="phone-msg" class="text-xs mt-2 pl-1 h-4 font-medium transition-colors duration-300"></p>
                        </div>
                        <div id="member-fields" class="space-y-4 transition-all duration-300">
                            <div><label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">收件人全名 <span class="text-brand">*</span></label><input type="text" id="input-name" required class="input-ui" placeholder="請輸入真實姓名"></div>
                            <div><label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">電子信箱 <span class="text-brand">*</span></label><input type="email" id="input-email" required class="input-ui" placeholder="接收訂單通知"></div>
                            <div><label class="text-xs font-bold text-gray-500 mb-1.5 block ml-1">LINE 顯示名稱</label><input type="text" id="input-line" class="input-ui" placeholder="方便聯絡 (選填)"></div>
                        </div>
                    </section>

                    <section>
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><span class="w-1 h-4 bg-brand rounded-full"></span> 配送方式</h4>
                        <div class="space-y-3">
                            <select id="input-logistics" class="hidden"><option value="7-11">7-11</option><option value="全家">全家</option><option value="郵寄/宅配">宅配</option></select>
                            
                            <div class="logistics-card cursor-pointer group" onclick="selectLogistics('7-11', this)">
                                <div class="p-4 flex justify-between items-center">
                                    <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand"><span class="material-symbols-rounded">local_shipping</span></div><div class="font-bold text-gray-800 text-sm">7-11 店到店</div></div>
                                    <span class="text-brand font-bold text-sm logistics-price" data-type="7-11">...</span>
                                </div>
                                <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4 space-y-3" onclick="event.stopPropagation()">
                                    <div class="flex gap-2">
                                        <input type="tel" class="input-ui flex-1 text-center font-mono tracking-widest" placeholder="輸入6碼店號" maxlength="6" inputmode="numeric" id="store-id-711" oninput="syncStoreInput()">
                                        <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="btn-query-store"><span class="material-symbols-rounded text-base">map</span> 查詢</a>
                                    </div>
                                    <input type="text" class="input-ui text-sm" placeholder="門市名稱 / 備註" id="store-name-711" oninput="syncStoreInput()">
                                </div>
                            </div>

                            <div class="logistics-card cursor-pointer group" onclick="selectLogistics('全家', this)">
                                <div class="p-4 flex justify-between items-center">
                                    <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand"><span class="material-symbols-rounded">store</span></div><div class="font-bold text-gray-800 text-sm">全家 店到店</div></div>
                                    <span class="text-brand font-bold text-sm logistics-price" data-type="全家">...</span>
                                </div>
                                <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4 space-y-3" onclick="event.stopPropagation()">
                                    <div class="flex gap-2">
                                        <input type="tel" class="input-ui flex-1 text-center font-mono tracking-widest" placeholder="輸入6碼店號" maxlength="6" inputmode="numeric" id="store-id-fami" oninput="syncStoreInput()">
                                        <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="btn-query-store"><span class="material-symbols-rounded text-base">map</span> 查詢</a>
                                    </div>
                                    <input type="text" class="input-ui text-sm" placeholder="門市名稱 / 備註" id="store-name-fami" oninput="syncStoreInput()">
                                </div>
                            </div>

                            <div class="logistics-card cursor-pointer group" onclick="selectLogistics('郵寄/宅配', this)">
                                <div class="p-4 flex justify-between items-center">
                                    <div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-brandLight flex items-center justify-center text-brand"><span class="material-symbols-rounded">local_shipping</span></div><div class="font-bold text-gray-800 text-sm">宅配到府</div></div>
                                    <span class="text-brand font-bold text-sm logistics-price" data-type="宅配">...</span>
                                </div>
                                <div class="logistics-detail hidden border-t border-brand/20 bg-brandLight/20 p-4" onclick="event.stopPropagation()">
                                    <textarea id="store-addr" class="input-ui text-sm min-h-[80px]" placeholder="請輸入完整收件地址 (含郵遞區號)" oninput="syncStoreInput()"></textarea>
                                </div>
                            </div>
                            
                            <input type="hidden" name="store" id="input-store">
                            <input type="hidden" name="store_note" id="input-store-note">
                        </div>
                    </section>

                    <section class="space-y-4">
                        <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2"><span class="w-1 h-4 bg-brand rounded-full"></span> 其他</h4>
                        <textarea id="input-note" class="input-ui min-h-[80px]" placeholder="訂單備註 (選填)..."></textarea>
                        <label class="flex items-center gap-3 p-4 bg-gray-50 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-100 transition">
                            <div class="relative flex items-center">
                                <input type="checkbox" id="join-member" class="peer h-5 w-5 cursor-pointer appearance-none rounded border border-gray-300 checked:bg-brand checked:border-brand transition-all" checked>
                                <span class="material-symbols-rounded absolute text-white opacity-0 peer-checked:opacity-100 pointer-events-none text-base left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">check</span>
                            </div>
                            <span class="text-sm text-gray-600 font-medium">更新並儲存會員資料 (下次自動帶入)</span>
                        </label>
                    </section>
                </div>
            </form>

            <div class="panel-footer shrink-0">
                <div class="panel-footer-btn-wrapper">
                    <div class="flex justify-between items-end mb-4">
                        <div class="text-xs text-gray-400 font-medium" id="footer-logistics-name">尚未選擇物流</div>
                        <div class="text-right flex items-baseline gap-2">
                            <span class="text-xs text-gray-400">總金額</span>
                            <span class="text-2xl font-bold text-brand font-mono">NT$ <span id="modal-total">0</span></span>
                        </div>
                    </div>
                    <button onclick="submitOrder(this)" class="w-full bg-brand text-white font-bold py-4 rounded-xl text-lg shadow-lg shadow-brand/20 hover:bg-brandDark active:scale-[0.98] transition flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                        <span class="material-symbols-rounded">verified</span> 確認送出訂單
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const ORDER_API_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec";
    const DISPLAY_API_URL = "https://script.google.com/macros/s/AKfycbxnxbcdCdxH2Qmuek5Up8BqTWeOLUcLR30jfUi0lMbMn5ocn9tY1f_c7yEyd9KSZ4Um/exec";
    const BASE_REPO_URL = "assets/images/"; 

    let allProducts = [];
    let cart = [];
    let shippingFee = 0;
    let shippingRules = [];
    let selectedLogisticsType = '';
    let tempQtyMap = {};
    let cachedMemberData = null;

    // --- 核心運費計算 (修正版：僅使用 category='抹茶' + 嚴格階梯計算) ---
    function calcShip(selectedLogistics, subtotal) {
        // 1. 資料來源檢查
        if (!shippingRules || shippingRules.length === 0) return 0;
        
        // 2. 規則選擇：category 為 '抹茶' 且 selectedLogistics 包含 rule.method
        const rule = shippingRules.find(r => 
            r.category === '抹茶' && 
            selectedLogistics.includes(r.method)
        );

        // 若無對應規則，依要求不使用 fallback，直接回傳 0
        if (!rule) return 0;

        // 3. 運費計算流程 (Base -> T3 -> T2 -> T1)
        let fee = Number(rule.base);
        
        if (rule.t3 && subtotal >= Number(rule.t3)) {
            fee = Number(rule.f3);
        } else if (rule.t2 && subtotal >= Number(rule.t2)) {
            fee = Number(rule.f2);
        } else if (rule.t1 && subtotal >= Number(rule.t1)) {
            fee = Number(rule.f1);
        }
        
        return fee;
    }

    // --- Core Panel Logic ---
    function openPanel(id) {
        const el = document.getElementById(id);
        const overlay = document.getElementById('overlay');
        if(el && overlay) {
            overlay.classList.add('open');
            el.classList.add('open');
        }
    }

    function closeAllPanels() {
        document.getElementById('overlay').classList.remove('open');
        document.querySelectorAll('.side-panel').forEach(el => el.classList.remove('open'));
    }

    function openCart() {
        renderCartItems();
        openPanel('cart-sidebar');
    }

    function openCheckout() {
        if (cart.length === 0) { alert('請先加入商品'); return; }
        
        document.querySelectorAll('.logistics-card').forEach(c => {
            c.classList.remove('active');
            c.querySelector('.logistics-detail').classList.add('hidden');
        });
        document.getElementById('input-store').value = '';
        document.getElementById('input-store-note').value = '';
        document.getElementById('footer-logistics-name').innerText = '尚未選擇物流';
        selectedLogisticsType = '';

        // Update shipping fee display logic
        updateShippingFee();

        if (cachedMemberData) {
            autoFillLogistics(cachedMemberData);
        }

        updateCheckoutReadonlyList();
        closeAllPanels();
        openPanel('checkout-panel');
    }

    // --- UI 更新：更新卡片上的價格 & 底部總結 ---
    function updateShippingFee() {
        const subtotal = calculateSubtotal();
        
        // 1. 遍歷所有物流卡片，依據目前小計更新「預覽運費」
        // 注意：這裡傳入的 type (如 '7-11', '郵寄/宅配') 會被 calcShip 用來對應規則
        ['7-11', '全家', '郵寄/宅配'].forEach(type => {
            const fee = calcShip(type, subtotal);
            // 這裡的 data-type 對應 HTML 上的設定 ('7-11', '全家', '宅配')
            // 由於 '郵寄/宅配' 在 HTML data-type 是 '宅配'，需做對應
            let uiType = type;
            if(type === '郵寄/宅配') uiType = '宅配';

            const el = document.querySelector(`.logistics-price[data-type="${uiType}"]`);
            if (el) {
                el.innerText = `運費 $${fee}`;
            }
        });

        // 2. 處理「已選擇」的物流狀態 (底部欄位)
        const uiMethod = selectedLogisticsType;
        
        if (uiMethod) {
            const finalFee = calcShip(uiMethod, subtotal);
            shippingFee = finalFee;

            document.getElementById('footer-logistics-name').innerText = `已選擇：${uiMethod} (運費 $${finalFee})`;
            document.getElementById('modal-total').innerText = (subtotal + finalFee).toLocaleString();
        } else {
            shippingFee = 0;
            document.getElementById('footer-logistics-name').innerText = '尚未選擇物流';
            document.getElementById('modal-total').innerText = subtotal.toLocaleString();
        }
    }

    // --- Cart Logic ---
    function addToCart(productId, name, price, priceMulti, stock, maxLimit) {
        const productData = allProducts.find(p => p.key === productId) || {};
        const brandKey = productData.brand_key || 'default';
        const spec = productData.spec || '';

        const qtyToAdd = tempQtyMap[productId] || 1;
        const existingItem = cart.find(item => item.productId === productId);
        
        let currentCartQty = existingItem ? existingItem.qty : 0;
        if (currentCartQty + qtyToAdd > stock) { alert("抱歉，庫存不足！"); return; }
        if (maxLimit && currentCartQty + qtyToAdd > maxLimit) { alert(`此商品每人限購 ${maxLimit} 件`); return; }

        if (existingItem) { 
            existingItem.qty += qtyToAdd; 
        } else { 
            cart.push({ 
                productId: productId, 
                brand_key: brandKey, 
                name: name, 
                spec: spec,
                price: price, 
                price_multi: priceMulti, 
                qty: qtyToAdd, 
                stock: stock,
                img: productData.img
            }); 
        }
        tempQtyMap[productId] = 1;
        const qtyDisplay = document.getElementById(`iq-${productId}`);
        if(qtyDisplay) qtyDisplay.innerText = 1;
        if (navigator.vibrate) navigator.vibrate(50);
        renderCartItems();
        openCart();
    }

    function getBrandCounts() {
        let counts = {};
        cart.forEach(item => {
            let k = item.brand_key || 'default';
            counts[k] = (counts[k] || 0) + item.qty;
        });
        return counts;
    }

    function calculateSubtotal() {
        const brandCounts = getBrandCounts();
        let subtotal = 0;
        cart.forEach(item => {
            let k = item.brand_key || 'default';
            let useDiscount = brandCounts[k] > 1;
            let finalPrice = useDiscount ? item.price_multi : item.price;
            subtotal += finalPrice * item.qty;
        });
        return subtotal;
    }

    function renderCartItems() {
        const container = document.getElementById('cart-items-wrapper');
        const subtotalEl = document.getElementById('cart-subtotal');
        container.innerHTML = '';
        
        if (cart.length === 0) {
            container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-300 gap-3"><span class="material-symbols-rounded text-5xl">shopping_basket</span><p class="text-sm font-medium">購物車是空的</p></div>`;
            subtotalEl.innerText = '0';
            document.getElementById('header-cart-badge').classList.add('hidden');
            return;
        }

        const brandCounts = getBrandCounts();
        const groupedCart = {};
        cart.forEach(item => {
            let k = item.brand_key || 'default';
            if(!groupedCart[k]) groupedCart[k] = [];
            groupedCart[k].push(item);
        });

        for (const [brandKey, items] of Object.entries(groupedCart)) {
            const isDiscountActive = brandCounts[brandKey] > 1;
            if(isDiscountActive) {
                container.innerHTML += `<div class="bg-brandLight text-brandDark text-xs font-bold px-4 py-2 flex items-center gap-1"><span class="material-symbols-rounded text-sm">verified</span>已套用同品牌多件優惠</div>`;
            }
            items.forEach((item) => {
                const mainIndex = cart.indexOf(item);
                const unitPrice = isDiscountActive ? item.price_multi : item.price;
                const isMultiPriceApplied = isDiscountActive && (item.price !== item.price_multi);
                let imgHtml = '';
                if (item.img) {
                    const src = item.img.startsWith('http') ? item.img : BASE_REPO_URL + item.img;
                    imgHtml = `<div class="w-16 h-16 bg-gray-50 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden border border-gray-100"><img src="${src}" class="w-full h-full object-cover"></div>`;
                }
                container.innerHTML += `
                    <div class="relative flex gap-4 items-start border-b border-gray-50 p-5 last:border-0 group bg-white">
                         ${imgHtml}
                        <div class="flex-1 min-w-0 flex flex-col justify-between min-h-[64px]">
                            <div class="pr-6">
                                <div class="font-bold text-gray-800 text-sm leading-tight line-clamp-2">${item.name}</div>
                                ${item.spec ? `<div class="text-[10px] text-gray-400 mt-0.5">${item.spec}</div>` : ''}
                                <div class="text-xs text-gray-400 mt-1 font-mono">
                                    ${isMultiPriceApplied ? `<span class="line-through text-gray-300 mr-1">$${item.price}</span>` : ''}
                                    <span class="${isMultiPriceApplied ? 'text-brand font-bold' : ''}">$${unitPrice}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-end mt-2">
                                <div class="flex items-center bg-gray-50 border border-gray-200 rounded-lg h-8">
                                    <button onclick="updateCartQty(${mainIndex}, -1)" class="w-8 h-full flex items-center justify-center text-gray-500 hover:text-brand hover:bg-gray-100 rounded-l-lg transition font-bold">-</button>
                                    <span class="w-8 text-center text-xs font-bold text-gray-700 font-mono">${item.qty}</span>
                                    <button onclick="updateCartQty(${mainIndex}, 1)" class="w-8 h-full flex items-center justify-center text-gray-500 hover:text-brand hover:bg-gray-100 rounded-r-lg transition font-bold">+</button>
                                </div>
                                <div class="font-bold text-brand font-mono">$${unitPrice * item.qty}</div>
                            </div>
                        </div>
                        <button onclick="removeFromCart(${mainIndex})" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 transition p-1"><span class="material-symbols-rounded text-xl">close</span></button>
                    </div>`;
            });
        }
        subtotalEl.innerText = calculateSubtotal().toLocaleString();
        const badge = document.getElementById('header-cart-badge');
        const totalQty = cart.reduce((acc, i) => acc + i.qty, 0);
        badge.innerText = totalQty;
        badge.classList.toggle('hidden', totalQty === 0);
    }

    function updateCartQty(index, delta) {
        if (!cart[index]) return;
        const item = cart[index];
        const newQty = item.qty + delta;
        if (delta > 0 && item.stock && newQty > item.stock) { alert('庫存不足'); return; }
        if (newQty < 1) return;
        item.qty = newQty;
        renderCartItems();
        if (document.getElementById('checkout-panel').classList.contains('open')) { 
            updateCheckoutReadonlyList(); 
            updateShippingFee(); 
        }
    }

    function removeFromCart(index) {
        if (!confirm('確定要移除此商品嗎？')) return;
        cart.splice(index, 1);
        renderCartItems();
        if (document.getElementById('checkout-panel').classList.contains('open')) { 
            updateCheckoutReadonlyList();
            updateShippingFee(); 
        }
    }

    function updateCheckoutReadonlyList() {
         const listEl = document.getElementById('checkout-readonly-list');
         listEl.innerHTML = '';
         cart.forEach(item => {
             listEl.innerHTML += `
                <li class="px-4 py-3 text-sm text-brandDark font-medium flex items-start gap-2">
                    <span class="material-symbols-rounded text-brand text-base mt-0.5">check_circle</span>
                    <span>
                        ${item.brand_key}｜${item.name} 
                        ${item.spec ? `<span class="text-xs bg-brandLight px-1 rounded ml-1">${item.spec}</span>` : ''}
                        <span class="text-xs text-gray-500 ml-1">x${item.qty}</span>
                    </span>
                </li>`;
         });
    }

    // --- Checkout & Validation Logic ---
    function lookupPhoneData(btn) {
        const input = document.getElementById('input-phone');
        const msg = document.getElementById('phone-msg');
        const phone = input.value.trim();
        const regex = /^09\d{8}$/;

        if (!regex.test(phone)) {
            msg.innerText = "格式錯誤，請輸入 09 開頭的 10 碼手機號碼";
            msg.className = "text-xs mt-2 pl-1 h-4 font-medium text-red-500";
            input.focus();
            return;
        }
        
        msg.innerText = "查詢中...";
        msg.className = "text-xs mt-2 pl-1 h-4 font-medium text-gray-400";
        btn.disabled = true;

        fetch(ORDER_API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "login", phone: phone })
        })
        .then(res => res.json())
        .then(data => {
            const info = (data.success && data.data) ? data.data : null;
            if(info && info.name) {
                msg.innerText = `歡迎回來，${info.name}`;
                msg.className = "text-xs mt-2 pl-1 h-4 font-bold text-brand";
                
                document.getElementById('input-name').value = info.name || '';
                document.getElementById('input-email').value = info.email || '';
                document.getElementById('input-line').value = info.line_name || '';
                
                cachedMemberData = info;
                autoFillLogistics(info);
            } else {
                msg.innerText = "新朋友您好，請填寫下方程式資料";
                msg.className = "text-xs mt-2 pl-1 h-4 font-medium text-gray-500";
                cachedMemberData = null;
            }
        })
        .catch(() => { msg.innerText = "連線失敗，請稍後再試"; })
        .finally(() => { btn.disabled = false; });
    }

    function autoFillLogistics(info) {
        if(!info) return;
        if(info.store_711) document.getElementById('store-id-711').value = info.store_711;
        if(info.store_711_note) document.getElementById('store-name-711').value = info.store_711_note;
        
        if(info.store_fami) document.getElementById('store-id-fami').value = info.store_fami;
        if(info.store_fami_note) document.getElementById('store-name-fami').value = info.store_fami_note;
        
        if(info.shipping_address) document.getElementById('store-addr').value = info.shipping_address;
    }

    function selectLogistics(type, cardEl) {
        document.querySelectorAll('.logistics-card').forEach(el => {
            el.classList.remove('active');
            el.querySelector('.logistics-detail').classList.add('hidden');
        });
        cardEl.classList.add('active');
        cardEl.querySelector('.logistics-detail').classList.remove('hidden');

        const select = document.getElementById('input-logistics');
        select.value = type;
        selectedLogisticsType = type;
        
        updateShippingFee();
        syncStoreInput();
    }

    function syncStoreInput() {
        let storeId = '';
        let storeName = '';

        if (selectedLogisticsType === '7-11') {
            storeId = document.getElementById('store-id-711').value.trim();
            storeName = document.getElementById('store-name-711').value.trim();
        } else if (selectedLogisticsType === '全家') {
            storeId = document.getElementById('store-id-fami').value.trim();
            storeName = document.getElementById('store-name-fami').value.trim();
        } else if (selectedLogisticsType && selectedLogisticsType.includes('宅配')) {
            storeId = document.getElementById('store-addr').value.trim(); 
        }

        document.getElementById('input-store').value = storeId;
        document.getElementById('input-store-note').value = storeName;
    }

    // --- 送出訂單 (含嚴格驗證) ---
    function submitOrder(btn) {
        // 1. 取得欄位值
        const phone = document.getElementById('input-phone').value.trim();
        const name = document.getElementById('input-name').value.trim();
        const email = document.getElementById('input-email').value.trim();
        const line = document.getElementById('input-line').value.trim();
        const note = document.getElementById('input-note').value.trim();
        
        // 物流相關
        const type = selectedLogisticsType; // 從全域變數拿比較穩
        const store = document.getElementById('input-store').value.trim();
        const storeNote = document.getElementById('input-store-note').value.trim();
        const isMemberCheck = document.getElementById('join-member').checked;

        // 2. 基礎驗證
        if (!/^09\d{8}$/.test(phone)) {
            alert("請輸入正確的手機號碼 (09開頭共10碼)");
            document.getElementById('input-phone').focus();
            return;
        }
        if (!name) { alert("請填寫收件人姓名"); document.getElementById('input-name').focus(); return; }
        if (!email) { alert("請填寫電子信箱"); document.getElementById('input-email').focus(); return; }
        
        if (!type) {
            alert("請選擇物流方式");
            document.getElementById('input-logistics').parentElement.scrollIntoView({behavior: 'smooth'});
            return;
        }

        // 3. 店號/地址 嚴格驗證
        if (type === '7-11') {
            if(!/^\d{6}$/.test(store)) {
                alert("請輸入正確的 7-11 「6碼純數字」店號");
                document.getElementById('store-id-711').focus();
                return;
            }
        } else if (type === '全家') {
            if(!/^\d{6}$/.test(store)) {
                alert("請輸入正確的全家 「6碼純數字」店號");
                document.getElementById('store-id-fami').focus();
                return;
            }
        } else if (type.includes('宅配')) {
            if(!store) {
                alert("請填寫宅配地址");
                document.getElementById('store-addr').focus();
                return;
            }
        }

        // 4. 準備送出
        btn.disabled = true;
        btn.innerHTML = '<span class="loader h-5 w-5 border-2 border-white rounded-full"></span> 處理中...';

        const subtotal = calculateSubtotal();
        // 送出前再算一次運費確保正確，payload 將使用此變數
        const finalShip = calcShip(type, subtotal);

        // 組合商品字串
        const itemsStr = cart.map(item => {
            return `${item.brand_key}｜${item.name}${item.spec ? '｜'+item.spec : ''} x${item.qty} ($${item.qty>1 && item.price_multi ? item.price_multi : item.price})`;
        }).join('\n');

        // 組合物流字串： "物流方式 店名備註"
        const logisticsStr = storeNote ? `${type} ${storeNote}` : type;

        const payload = {
            action: "checkout",
            phone: phone, 
            name: name, 
            email: email,
            line_name: line,
            logistics: logisticsStr, // 組合後的字串
            store: store,            // 純店號/地址
            store_note: storeNote,   // 純備註
            items: itemsStr,
            subtotal: subtotal, 
            shipping: finalShip,     // 使用 calcShip 算出的結果 (唯一修改重點)
            date: new Date().toISOString(),
            product_note: note,
            join_member: isMemberCheck
        };

        fetch(ORDER_API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                alert(`訂單建立成功！\n編號：${data.orderId}`);
                cart = [];
                updateCartQty(0, 0); 
                document.getElementById('cart-items-wrapper').innerHTML = ''; 
                document.getElementById('header-cart-badge').classList.add('hidden');
                closeAllPanels();
            } else {
                alert("建立失敗：" + data.msg);
            }
        })
        .catch((err) => {
            console.error(err);
            alert("系統連線錯誤，請稍後再試");
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<span class="material-symbols-rounded">verified</span> 確認送出訂單';
        });
    }

    function adjQty(productId, change) {
         if (!tempQtyMap[productId]) tempQtyMap[productId] = 1;
         let newQty = tempQtyMap[productId] + change;
         if (newQty < 1) newQty = 1; 
         tempQtyMap[productId] = newQty;
         const qtyDisplay = document.getElementById(`iq-${productId}`);
         if (qtyDisplay) { qtyDisplay.innerText = newQty; }
    }

    window.addEventListener('load', () => {
         const loader = document.getElementById('status-loader');
         
         // 並行請求：ORDER_API_URL 抓取運費規則 (必須)，DISPLAY_API_URL 抓取商品 (維持原狀)
         Promise.all([
             fetch(ORDER_API_URL).then(res => res.json()), // 請求運費規則
             fetch(DISPLAY_API_URL).then(res => res.json()) // 請求商品資料
         ])
            .then(([rulesData, displayData]) => {
                // 1. 處理運費規則 (完整保存，來自 ORDER_API_URL)
                if (rulesData.shipping_rules) {
                    shippingRules = rulesData.shipping_rules;
                }

                // 2. 處理商品資料 (維持原狀)
                if(displayData.error) throw new Error(displayData.error);
                
                allProducts = (displayData.products || []).map(p => {
                    p.key = p.brand_key + '_' + p.name; 
                    return p;
                });

                renderStatusOverview(displayData.brands);
                renderProductSections(displayData.brands);
                displayData.brands.forEach(brand => {
                    renderProductCards(brand.key, allProducts.filter(p => p.brand_key === brand.key));
                });
                
                // 初始化運費顯示
                updateShippingFee();

                loader.style.display = 'none';
            })
            .catch(err => {
                console.error(err);
                const container = document.getElementById('status-grid-container');
                if(container) container.innerHTML = `<p class="text-center text-red-500 w-full col-span-2">資料載入失敗</p>`;
                loader.style.display = 'none';
            });
    });

    // (Render functions)
    function renderStatusOverview(brands) {
        const container = document.getElementById('status-grid-container');
        if (!container) return;
        container.innerHTML = '';
        const sortedBrands = brands.sort((a, b) => (Number(a.order) || 999) - (Number(b.order) || 999));
        sortedBrands.forEach(brand => {
            const rawStatus = (brand.status || '').toLowerCase().trim();
            let statusText = brand.status || '未定';
            let statusClass = 'bg-gray-200 text-gray-600';
            if (['available', 'open', '开团', '開團', '接收訂單中', '收單中', '可供訂購', '可訂購'].includes(rawStatus)) {
                statusText = '可訂購'; statusClass = 'bg-brand text-white';
            } else { statusText = '缺貨中'; }
            container.innerHTML += `
                <a href="#brand-${brand.key}" class="block group transform hover:-translate-y-1 transition-transform duration-300">
                    <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-4 border border-gray-100 flex justify-between items-center">
                        <span class="font-bold text-gray-800 text-lg group-hover:text-brand transition-colors">${brand.name}</span>
                        <span class="${statusClass} text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap shadow-sm">${statusText}</span>
                    </div>
                </a>`;
        });
    }
    function renderProductSections(brands) {
        const container = document.getElementById('product-list-container');
        if (!container) return;
        container.innerHTML = '';
        brands.forEach(brand => {
            container.innerHTML += `
                <section id="brand-${brand.key}" class="scroll-mt-24">
                    <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-800 border-b pb-4">
                        <span class="w-2 h-6 bg-brand rounded-full"></span>${brand.name}
                    </h2>
                    <div id="${brand.key}-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>`;
        });
    }
    function renderProductCards(brandKey, products) {
        const grid = document.getElementById(`${brandKey}-grid`);
        if (!grid) return;
        if (products.length === 0) { grid.innerHTML = `<p class="text-gray-400 text-center col-span-full py-8">尚無品項或是缺貨中</p>`; return; }
        products.forEach(product => {
            const productId = product.key;
            const name = product.name || '未命名';
            const price = Number(product.price) || 0;
            const priceMulti = Number(product.price_multi) || 0;
            const status = product.status || '';
            const note = product.note || '';       
            const tag = product.tag || '';          
            const spec = product.spec || '';       
            const imgPath = String(product.img || ''); 
            let isStockZero = false;
            if (product.stock !== "" && product.stock !== undefined) { if (Number(product.stock) <= 0) isStockZero = true; }
            const isSoldOut = isStockZero || status.includes('完售');
            const hasImage = imgPath !== '';
            const hasMultiPrice = (priceMulti > 0 && priceMulti < price);
            let imgHTML = '';
            if (hasImage) {
                const src = imgPath.startsWith('http') ? imgPath : BASE_REPO_URL + imgPath;
                imgHTML = `
                    <div class="card-img-group w-full aspect-square relative overflow-hidden bg-gray-50 md:order-first md:relative md:aspect-square md:w-full md:bg-gray-50 md:overflow-hidden">
                        <img src="${src}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy">
                    </div>`;
            }
            let badgeHTML = '';
            if (tag) { badgeHTML = `<span class="absolute top-3 right-3 bg-brand text-white text-xs font-semibold px-2.5 py-0.5 rounded-full z-10 shadow-sm">${tag}</span>`; } 
            else if (isSoldOut) { badgeHTML = `<span class="absolute top-3 right-3 bg-gray-500 text-white text-xs font-semibold px-2.5 py-0.5 rounded-full z-10 shadow-sm">缺貨</span>`; }
            let priceHTML = '';
            if (hasMultiPrice) {
                priceHTML = `<div class="flex flex-col items-end w-full"><span class="text-xs text-gray-400">單件 $${price}</span><span class="text-brand font-bold text-lg font-mono">2件起 $${priceMulti}</span></div>`;
            } else {
                priceHTML = `<div class="w-full text-right"><span class="text-brand font-bold text-lg font-mono">NT$ ${price}</span></div>`;
            }
            const btnClass = isSoldOut ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-brand text-white transition active:scale-95 hover:bg-brandDark shadow-md shadow-brand/10';
            const clickEvent = isSoldOut ? '' : `onclick="addToCart('${productId}', '${name}', ${price}, ${priceMulti}, ${product.stock}, ${product.max_limit})"`;
            const btnText = isSoldOut ? '完售' : '加入購物車';
            const qtyDisable = isSoldOut ? 'disabled opacity-50' : '';
            const topRowClass = `flex gap-4 md:contents ${hasImage ? 'items-center' : ''}`;
            grid.innerHTML += `
                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex flex-col mobile-product-card transition hover:shadow-lg group relative">
                    ${badgeHTML}
                    <div class="p-4 md:p-0 ${topRowClass}">
                        ${imgHTML}
                        <div class="card-info-group flex-1 flex flex-col gap-3 md:p-5">
                            <h4 class="font-bold text-gray-800 text-xl leading-tight line-clamp-1 flex items-baseline">
                                ${name}${spec ? `<span class="ml-2 text-gray-400 text-xs font-normal whitespace-nowrap">${spec}</span>` : ''}
                            </h4>
                            ${ note ? `<p class="text-gray-400 text-[11px] leading-relaxed line-clamp-2 min-h-[1.5em]">${note}</p>` : '' }
                            <div class="mt-auto">${priceHTML}</div>
                        </div>
                    </div>
                    <div class="flex gap-2 p-4 pt-0 md:p-5 md:border-t">
                        <div class="flex items-center justify-between bg-white border border-gray-200 rounded-xl px-2 h-12 w-1/3">
                            <button class="w-8 h-full flex items-center justify-center text-brand font-bold" onclick="adjQty('${productId}', -1)" ${qtyDisable}>-</button>
                            <span id="iq-${productId}" class="text-xs font-bold px-2 text-center">1</span>
                            <button class="w-8 h-full flex items-center justify-center text-brand font-bold" onclick="adjQty('${productId}', 1)" ${qtyDisable}>+</button>
                        </div>
                        <button class="flex-1 h-12 rounded-xl text-xs font-bold ${btnClass}" ${clickEvent}>${btnText}</button>
                    </div>
                </div>`;
        });
    }
</script>
