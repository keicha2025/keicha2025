
---
layout: default
title: KEICHA ç¶²è·¯å•†åº—
---

<style>
    .brand-green { color: #6ea44c; }
    .bg-brand-green { background-color: #6ea44c; }
    
    /* å´é‚Šé¢æ¿èˆ‡é®ç½© */
    .side-panel {
        position: fixed; top: 0; right: 0; height: 100%; width: 100%; max-width: 420px;
        background-color: white; z-index: 200; transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
    }
    .side-panel.open { transform: translateX(0); }
    
    .overlay {
        position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 190;
        opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(4px);
    }
    .overlay.open { opacity: 1; visibility: visible; }

    /* è³¼ç‰©è»Šæ¨£å¼ */
    .cart-item-row { display: flex; align-items: center; gap: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #f3f4f6; }
    .cart-item-img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; background-color: #f9fafb; }
    .cart-qty-control { display: flex; align-items: center; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 2px; }
    .cart-qty-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #6ea44c; cursor: pointer; }
    .cart-qty-num { width: 30px; text-align: center; font-size: 13px; font-weight: 700; color: #374151; }
    .btn-outline-brand { background-color: white; color: #6ea44c; border: 2px solid #6ea44c; width: 100%; padding: 0.8rem; border-radius: 0.75rem; font-weight: bold; transition: all 0.2s; font-size: 0.875rem; }
    .btn-outline-brand:hover { background-color: rgba(110, 164, 76, 0.05); }

    /* è¼¸å…¥æ¡†æ¨£å¼ */
    .user-edit-input { width: 100%; padding: 0.5rem 0; border: none; border-bottom: 2px solid #6ea44c; outline: none; background-color: transparent; transition: all 0.3s; }
    .checkout-inline-input { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; outline: none; transition: border-color 0.2s; }
    .checkout-inline-input:focus { border-color: #6ea44c; ring: 1px solid #6ea44c; }
    
    /* æ‡¸æµ®è³¼ç‰©è»ŠæŒ‰éˆ• */
    .cart-floating-btn {
        position: fixed; bottom: 2rem; right: 2rem; width: 4rem; height: 4rem;
        background-color: #6ea44c; color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    /* è¼‰å…¥ä¸­å‹•ç•« */
    .animate-spin-custom { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* =========================================
       ğŸ“¦ å•†å“å¡ç‰‡æ¨£å¼å„ªåŒ– (Product Card Styles)
       ========================================= */
    
    /* æ•¸é‡æ§åˆ¶å€å¡Šï¼šæ¨£å¼åŒ–ç‚ºç¨ç«‹å®¹å™¨ */
    .qty-control { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; /* æŒ‰éˆ•èˆ‡æ•¸å­—å¹³å‡åˆ†ä½ˆ */
        background: #ffffff; 
        border: 1px solid #e5e7eb; 
        border-radius: 0.75rem; /* rounded-xl (12px) é…åˆæŒ‰éˆ•åœ“è§’ */
        padding: 0 8px; 
        height: 48px; /* å›ºå®šé«˜åº¦ï¼Œèˆ‡æŒ‰éˆ•ä¸€è‡´ */
        box-sizing: border-box;
    }
    
    /* æ•¸é‡æŒ‰éˆ• */
    .qty-btn { 
        width: 32px; 
        height: 32px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        background: transparent; 
        border-radius: 8px; 
        font-weight: bold; 
        cursor: pointer; 
        border: none;
        color: #6ea44c;
        transition: background-color 0.2s;
    }
    .qty-btn:hover { background-color: #f3f4f6; }
    
    /* åŠ å…¥è³¼ç‰©è»ŠæŒ‰éˆ•ï¼šç¢ºä¿é«˜åº¦ä¸€è‡´ */
    .add-btn {
        height: 48px !important; /* å¼·åˆ¶é«˜åº¦èˆ‡æ•¸é‡æ¡†ä¸€è‡´ */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 16px; /* å·¦å³å…§è· */
    }

    /* æ‰‹æ©Ÿç‰ˆé©é… */
    @media (max-width: 767px) {
        .mobile-product-card { 
            display: flex !important; 
            flex-direction: column !important; 
            padding: 16px !important;
            gap: 12px !important;
        }
        .card-top-row { 
            display: flex !important; 
            flex-direction: row !important; 
            align-items: flex-start !important; 
            gap: 16px !important; 
            width: 100%;
        }
        .card-img-group { 
            width: 100px !important; 
            height: 100px !important; 
            flex-shrink: 0 !important;
            border-radius: 12px !important;
            overflow: hidden;
            background-color: #f9fafb;
        }
        .card-info-group {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: space-between;
            min-height: 100px;
        }
        /* åº•éƒ¨æŒ‰éˆ•å€ï¼šæ‰‹æ©Ÿç‰ˆä¿æŒæ©«å‘æ’åˆ— */
        .card-bottom-row {
            display: flex !important;
            flex-direction: row !important;
            gap: 12px !important;
            width: 100%;
            padding: 0 !important;
            border-top: none !important;
        }
        /* æ‰‹æ©Ÿç‰ˆæ¯”ä¾‹é…ç½® */
        .qty-control {
            flex: 1 !important; 
            /* height å·²ç¶“ç”±é€šç”¨æ¨£å¼è¨­å®šç‚º 48px */
        }
        .add-btn {
            flex: 1.5 !important;
            /* height å·²ç¶“ç”±é€šç”¨æ¨£å¼è¨­å®šç‚º 48px */
        }
    }
</style>

<div class="bg-white border-b border-gray-100">
    <div class="container mx-auto px-4 max-w-6xl py-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold tracking-tight text-gray-800">KEICHA ç¶²è·¯å•†åº—</h1>
        <div id="top-auth-zone"></div>
    </div>
</div>

<section id="announcement-section" class="hidden py-3 bg-yellow-50 border-b border-yellow-100">
    <div class="container mx-auto px-4 text-center text-sm font-medium text-yellow-800" id="announcement-content"></div>
</section>

<main class="max-w-6xl mx-auto p-4 md:p-10 space-y-12 min-h-screen">
    <div id="products-loader" class="flex justify-center items-center h-48">
        <div class="w-10 h-10 border-4 border-gray-200 border-t-[#6ea44c] rounded-full animate-spin"></div>
    </div>
    <div id="category-container" class="space-y-16"></div>
</main>

<div id="global-overlay" class="overlay" onclick="closeAllPanels()"></div>

<div id="login-panel" class="side-panel">
    <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center">
        <h3 class="font-bold flex items-center gap-2 text-white"><span class="material-symbols-rounded">login</span> æœƒå“¡ç™»å…¥</h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-white">close</button>
    </div>
    <div class="p-8 space-y-6">
        <div class="text-center space-y-2"><p class="text-gray-600 font-bold">æ­¡è¿ä¾†åˆ° KEICHA</p><p class="text-xs text-gray-400">è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼å¿«é€Ÿç™»å…¥</p></div>
        <input type="tel" id="login-phone" placeholder="ä¾‹å¦‚ï¼š0912345678" class="w-full p-4 bg-gray-50 border rounded-2xl text-lg font-bold outline-none focus:ring-1 ring-[#6ea44c]">
        <button onclick="handleQuickLogin()" id="login-submit-btn" class="w-full bg-[#6ea44c] text-white py-4 rounded-2xl font-bold shadow-lg flex justify-center items-center gap-2">
            <span id="login-text">ä¸‹ä¸€æ­¥</span><span id="login-icon" class="material-symbols-rounded">arrow_forward</span>
        </button>
    </div>
</div>

<div id="cart-sidebar" class="side-panel">
    <div class="p-6 border-b flex justify-between items-center bg-white sticky top-0 z-10">
        <h3 class="font-bold flex items-center gap-2 text-gray-800">
            <span class="material-symbols-rounded">shopping_cart</span> è³¼ç‰©è»Š
        </h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-gray-400 hover:text-gray-600">close</button>
    </div>
    <div id="cart-items-container" class="flex-grow overflow-y-auto p-6 space-y-6">
        </div>
    <div class="p-6 border-t bg-gray-50 space-y-3">
        <div class="flex justify-between items-center font-bold mb-2">
            <span class="text-gray-600">å•†å“å°è¨ˆ</span>
            <span id="cart-total-price" class="text-xl brand-green">NT$ 0</span>
        </div>
        <button id="trigger-checkout-btn" class="w-full bg-[#6ea44c] text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2">
            å‰å¾€çµå¸³ <span class="material-symbols-rounded text-sm">arrow_forward</span>
        </button>
        <button onclick="closeAllPanels()" class="btn-outline-brand flex items-center justify-center gap-2">
            <span class="material-symbols-rounded text-sm">arrow_back</span> è¿”å›å•†åº—ç¹¼çºŒé¸è³¼
        </button>
    </div>
</div>

<div id="user-panel" class="side-panel">
    <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center sticky top-0 z-10">
        <h3 class="font-bold flex items-center gap-2">
            <span class="material-symbols-rounded">account_circle</span> æœƒå“¡è³‡æ–™ç®¡ç†
        </h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-white hover:opacity-70 transition">close</button>
    </div>

    <div id="panel-body" class="p-8 flex-1 overflow-y-auto space-y-10">
        <div class="flex items-center justify-between bg-gray-50 p-4 rounded-2xl">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">ç›®å‰å¸³è™Ÿ</span>
            <span id="display-user-phone" class="font-mono font-bold text-[#6ea44c]">-</span>
        </div>

        <section class="space-y-4">
            <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                <h4 class="text-xs font-bold brand-green uppercase tracking-widest">å€‹äººåŸºæœ¬è³‡è¨Š</h4>
                <button onclick="toggleEdit('info')" class="material-symbols-rounded text-[#6ea44c] hover:bg-[#6ea44c]/10 rounded-full p-1 transition">edit_square</button>
            </div>
            
            <div class="space-y-6">
                <div class="field-group">
                    <label class="text-[10px] text-gray-400 font-bold mb-1 block">æ”¶ä»¶äººå…¨å</label>
                    <div class="min-h-[40px] flex items-center">
                        <span id="text-name" class="font-bold text-gray-700"></span>
                        <input type="text" id="upd-name" class="user-edit-input font-bold hidden" placeholder="è«‹è¼¸å…¥å§“å">
                    </div>
                </div>
                <div class="field-group">
                    <label class="text-[10px] text-gray-400 font-bold mb-1 block">é›»å­éƒµä»¶</label>
                    <div class="min-h-[40px] flex items-center">
                        <span id="text-email" class="text-gray-700"></span>
                        <input type="email" id="upd-email" class="user-edit-input hidden" placeholder="example@mail.com">
                    </div>
                </div>
                <div id="info-edit-actions" class="hidden flex gap-3 pt-2">
                    <button onclick="saveFullUser('info')" id="save-btn-info" class="flex-1 bg-[#6ea44c] text-white py-3 rounded-xl font-bold shadow-sm active:scale-95 transition-all flex justify-center items-center gap-2">
                        <span class="material-symbols-rounded text-sm">save</span>å„²å­˜
                    </button>
                    <button onclick="toggleEdit('info')" class="flex-1 border border-gray-300 text-gray-600 py-3 rounded-xl font-bold active:scale-95 transition-all">å–æ¶ˆ</button>
                </div>
            </div>
        </section>

        <section class="space-y-8">
            <h4 class="text-xs font-bold brand-green uppercase tracking-widest border-b border-gray-100 pb-2">é è¨­ç‰©æµè¨­å®š</h4>

            <div class="bg-gray-50 p-5 rounded-3xl space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500">7-11 é–€å¸‚è³‡æ–™</span>
                    <div class="flex items-center gap-2">
                        <a id="btn-711-query" href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="hidden text-[10px] bg-[#6ea44c] text-white px-3 py-1 rounded-full font-bold">æŸ¥è©¢åº—è™Ÿ</a>
                        <button onclick="toggleEdit('711')" class="material-symbols-rounded text-[#6ea44c] text-xl">edit_square</button>
                    </div>
                </div>
                <div id="display-711" class="font-bold text-sm text-gray-700">å°šæœªè¨­å®š</div>
                <div id="edit-711" class="hidden space-y-3">
                    <input type="text" id="upd-711" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-1 ring-[#6ea44c] outline-none text-sm font-bold bg-white" placeholder="è«‹è¼¸å…¥6ç¢¼åº—è™Ÿ">
                    <input type="text" id="upd-711-note" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-1 ring-[#6ea44c] outline-none text-sm bg-white" placeholder="åº—åå‚™è¨» (ä¾‹å¦‚ï¼šç§‘æ…¶é–€å¸‚)">
                    <div class="flex gap-2 pt-1">
                        <button onclick="saveFullUser('711')" id="save-btn-711" class="flex-1 bg-[#6ea44c] text-white py-2 rounded-xl text-xs font-bold flex justify-center items-center gap-2">
                            <span class="material-symbols-rounded text-sm">save</span>å„²å­˜
                        </button>
                        <button onclick="toggleEdit('711')" class="flex-1 border border-gray-300 text-gray-500 py-2 rounded-xl text-xs font-bold">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-5 rounded-3xl space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500">å…¨å®¶ é–€å¸‚è³‡æ–™</span>
                    <div class="flex items-center gap-2">
                        <a id="btn-fami-query" href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="hidden text-[10px] bg-[#6ea44c] text-white px-3 py-1 rounded-full font-bold">æŸ¥è©¢åº—è™Ÿ</a>
                        <button onclick="toggleEdit('fami')" class="material-symbols-rounded text-[#6ea44c] text-xl">edit_square</button>
                    </div>
                </div>
                <div id="display-fami" class="font-bold text-sm text-gray-700">å°šæœªè¨­å®š</div>
                <div id="edit-fami" class="hidden space-y-3">
                    <input type="text" id="upd-fami" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-1 ring-[#6ea44c] outline-none text-sm font-bold bg-white" placeholder="è«‹è¼¸å…¥6ç¢¼åº—è™Ÿ">
                    <input type="text" id="upd-fami-note" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-1 ring-[#6ea44c] outline-none text-sm bg-white" placeholder="åº—åå‚™è¨» (ä¾‹å¦‚ï¼šå…¨å®¶æ…¶ä¸­åº—)">
                    <div class="flex gap-2 pt-1">
                        <button onclick="saveFullUser('fami')" id="save-btn-fami" class="flex-1 bg-[#6ea44c] text-white py-2 rounded-xl text-xs font-bold flex justify-center items-center gap-2">
                            <span class="material-symbols-rounded text-sm">save</span>å„²å­˜
                        </button>
                        <button onclick="toggleEdit('fami')" class="flex-1 border border-gray-300 text-gray-500 py-2 rounded-xl text-xs font-bold">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-5 rounded-3xl space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-500">å®…é…å¸¸ç”¨åœ°å€</span>
                    <button onclick="toggleEdit('addr')" class="material-symbols-rounded text-[#6ea44c] text-xl">edit_square</button>
                </div>
                <div id="display-addr" class="font-bold text-sm text-gray-700 leading-relaxed">å°šæœªè¨­å®š</div>
                <div id="edit-addr" class="hidden space-y-3">
                    <textarea id="upd-addr" class="w-full p-4 rounded-xl border border-gray-200 focus:ring-1 ring-[#6ea44c] outline-none text-sm resize-none bg-white" rows="3" placeholder="è«‹è¼¸å…¥å®Œæ•´æ”¶ä»¶åœ°å€"></textarea>
                    <div class="flex gap-2 pt-1">
                        <button onclick="saveFullUser('addr')" id="save-btn-addr" class="flex-1 bg-[#6ea44c] text-white py-2 rounded-xl text-xs font-bold flex justify-center items-center gap-2">
                            <span class="material-symbols-rounded text-sm">save</span>å„²å­˜
                        </button>
                        <button onclick="toggleEdit('addr')" class="flex-1 border border-gray-300 text-gray-500 py-2 rounded-xl text-xs font-bold">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="pt-6 border-t border-gray-100 flex flex-col gap-3">
            <button onclick="closeAllPanels()" class="w-full border border-gray-200 text-gray-600 py-4 rounded-xl font-bold hover:bg-gray-50 active:scale-95 transition-all flex justify-center items-center gap-2">
                <span class="material-symbols-rounded text-lg">expand_more</span> é—œé–‰æœƒå“¡ä¸­å¿ƒ
            </button>
            <button onclick="handleLogout()" class="w-full text-xs text-gray-300 font-bold hover:text-red-400 transition-colors py-3 text-center">
                å®‰å…¨ç™»å‡ºæ­¤å¸³è™Ÿ
            </button>
        </section>
    </div>
</div>

<div id="checkout-panel" class="side-panel">
    <div class="p-6 bg-[#6ea44c] text-white flex justify-between items-center sticky top-0 z-10">
        <h3 class="font-bold flex items-center gap-2">
            <span class="material-symbols-rounded">shopping_cart_checkout</span> è¨‚å–®çµå¸³ç¢ºèª
        </h3>
        <button onclick="closeAllPanels()" class="material-symbols-rounded text-white hover:opacity-70 transition">close</button>
    </div>

    <div class="p-8 flex-1 overflow-y-auto space-y-10">
        <section class="space-y-4">
            <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                <h4 class="text-xs font-bold brand-green uppercase tracking-widest">åŸºæœ¬è³‡æ–™ç¢ºèª</h4>
                <button onclick="toggleCheckoutEdit('info')" class="text-[10px] brand-green font-bold border border-[#6ea44c] px-2 py-0.5 rounded-lg hover:bg-[#6ea44c] hover:text-white transition">ç·¨è¼¯</button>
            </div>
            
            <div id="checkout-view-info" class="space-y-4 bg-gray-50/50 p-4 rounded-2xl">
                <div class="field-group border-b border-gray-200 pb-3">
                    <label class="text-[10px] text-gray-400 font-bold block mb-1">æ‰‹æ©Ÿè™Ÿç¢¼ (æœƒå“¡å¸³è™Ÿ)</label>
                    <div id="checkout-info-phone" class="font-bold text-gray-700 text-lg font-mono">-</div>
                </div>

                <div class="field-group">
                    <label class="text-[10px] text-gray-400 font-bold block mb-1">æ”¶ä»¶äººå…¨å <span class="text-red-500">*</span></label>
                    <div id="checkout-info-name" class="font-bold text-gray-700 text-sm">-</div>
                </div>
                
                <div class="field-group">
                    <label class="text-[10px] text-gray-400 font-bold block mb-1">é›»å­ä¿¡ç®± (æ¥æ”¶è¨‚å–®é€šçŸ¥) <span class="text-red-500">*</span></label>
                    <div id="checkout-info-email" class="font-bold text-gray-700 text-sm break-all">-</div>
                </div>
            </div>

            <div id="checkout-edit-info" class="hidden bg-gray-50 p-4 rounded-2xl space-y-3">
                <div>
                    <label class="text-[10px] text-gray-400 font-bold mb-1 block">æ”¶ä»¶äººå…¨å <span class="text-red-500">*</span></label>
                    <input type="text" id="chk-input-name" class="checkout-inline-input w-full" placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
                </div>
                <div>
                    <label class="text-[10px] text-gray-400 font-bold mb-1 block">é›»å­ä¿¡ç®± <span class="text-red-500">*</span></label>
                    <input type="email" id="chk-input-email" class="checkout-inline-input w-full" placeholder="ä¾‹å¦‚: example@gmail.com">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="saveCheckoutData('info')" id="chk-save-info" class="flex-1 bg-[#6ea44c] text-white py-2 rounded-lg text-xs font-bold flex justify-center items-center gap-1">å„²å­˜è³‡æ–™</button>
                    <button onclick="toggleCheckoutEdit('info')" class="flex-1 border border-gray-300 text-gray-500 py-2 rounded-lg text-xs font-bold">å–æ¶ˆ</button>
                </div>
            </div>

            <div class="field-group">
                <label class="text-[10px] text-gray-400 font-bold mb-1 block">LINE é¡¯ç¤ºåç¨± (æ ¸å°è¨‚å–®ç”¨) <span class="text-red-500">*</span></label>
                <input type="text" id="order-line-name" class="user-edit-input font-bold" placeholder="è«‹è¼¸å…¥æ‚¨çš„ LINE åç¨±">
            </div>
        </section>

        <section class="space-y-4">
            <h4 class="text-xs font-bold brand-green uppercase tracking-widest border-b border-gray-100 pb-2">é¸æ“‡æ”¶ä»¶æ–¹å¼</h4>
            <div id="ship-options-container" class="space-y-3">
                
                <div onclick="selectShipMethod('7-11')" id="opt-7-11" class="ship-opt-card p-5 rounded-3xl border-2 border-gray-50 cursor-pointer transition-all">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-rounded text-gray-400 text-2xl">local_shipping</span>
                            <div>
                                <div class="font-bold text-sm text-gray-800">7-11 åº—åˆ°åº—</div>
                                <div id="checkout-display-7-11" class="text-[11px] text-gray-500 mt-0.5">-</div>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); toggleCheckoutEdit('711');" class="text-[10px] brand-green font-bold border border-[#6ea44c] px-3 py-1 rounded-full bg-white">ç·¨è¼¯</button>
                    </div>
                    <div id="checkout-edit-711" class="hidden mt-4 pt-4 border-t border-gray-100 cursor-default" onclick="event.stopPropagation()">
                         <div class="flex gap-2 mb-2">
                             <input type="text" id="chk-input-711" class="checkout-inline-input flex-1" placeholder="è«‹è¼¸å…¥6ç¢¼åº—è™Ÿ">
                             <a href="https://www.ibon.com.tw/mobile/retail_inquiry.aspx" target="_blank" class="bg-[#6ea44c] text-white px-4 rounded-lg text-xs font-bold flex items-center justify-center whitespace-nowrap shadow-sm active:scale-95 transition">æŸ¥è©¢åº—è™Ÿ</a>
                         </div>
                         <input type="text" id="chk-input-711-note" class="checkout-inline-input w-full mb-3" placeholder="åº—åå‚™è¨» (ä¾‹å¦‚: ç§‘æ…¶é–€å¸‚)">
                         <div class="flex gap-2">
                             <button onclick="saveCheckoutData('711')" id="chk-save-711" class="flex-1 bg-[#6ea44c] text-white py-2 rounded-lg text-xs font-bold flex justify-center items-center gap-1">å„²å­˜</button>
                             <button onclick="toggleCheckoutEdit('711')" class="flex-1 border border-gray-300 text-gray-500 py-2 rounded-lg text-xs font-bold">å–æ¶ˆ</button>
                         </div>
                    </div>
                </div>

                <div onclick="selectShipMethod('fami')" id="opt-fami" class="ship-opt-card p-5 rounded-3xl border-2 border-gray-50 cursor-pointer transition-all">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-rounded text-gray-400 text-2xl">store</span>
                            <div>
                                <div class="font-bold text-sm text-gray-800">å…¨å®¶ åº—åˆ°åº—</div>
                                <div id="checkout-display-fami" class="text-[11px] text-gray-500 mt-0.5">-</div>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); toggleCheckoutEdit('fami');" class="text-[10px] brand-green font-bold border border-[#6ea44c] px-3 py-1 rounded-full bg-white">ç·¨è¼¯</button>
                    </div>
                     <div id="checkout-edit-fami" class="hidden mt-4 pt-4 border-t border-gray-100 cursor-default" onclick="event.stopPropagation()">
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="chk-input-fami" class="checkout-inline-input flex-1" placeholder="è«‹è¼¸å…¥6ç¢¼åº—è™Ÿ">
                            <a href="https://www.family.com.tw/marketing/inquiry.aspx" target="_blank" class="bg-[#6ea44c] text-white px-4 rounded-lg text-xs font-bold flex items-center justify-center whitespace-nowrap shadow-sm active:scale-95 transition">æŸ¥è©¢åº—è™Ÿ</a>
                        </div>
                        <input type="text" id="chk-input-fami-note" class="checkout-inline-input w-full mb-3" placeholder="åº—åå‚™è¨» (ä¾‹å¦‚: å…¨å®¶æ…¶ä¸­åº—)">
                        <div class="flex gap-2">
                            <button onclick="saveCheckoutData('fami')" id="chk-save-fami" class="flex-1 bg-[#6ea44c] text-white py-2 rounded-lg text-xs font-bold flex justify-center items-center gap-1">å„²å­˜</button>
                            <button onclick="toggleCheckoutEdit('fami')" class="flex-1 border border-gray-300 text-gray-500 py-2 rounded-lg text-xs font-bold">å–æ¶ˆ</button>
                        </div>
                   </div>
                </div>

                <div onclick="selectShipMethod('addr')" id="opt-addr" class="ship-opt-card p-5 rounded-3xl border-2 border-gray-50 cursor-pointer transition-all">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="material-symbols-rounded text-gray-400 text-2xl">home</span>
                            <div>
                                <div class="font-bold text-sm text-gray-800">å®…é…åˆ°åºœ</div>
                                <div id="checkout-display-addr" class="text-[11px] text-gray-500 mt-0.5">-</div>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); toggleCheckoutEdit('addr');" class="text-[10px] brand-green font-bold border border-[#6ea44c] px-3 py-1 rounded-full bg-white">ç·¨è¼¯</button>
                    </div>
                    <div id="checkout-edit-addr" class="hidden mt-4 pt-4 border-t border-gray-100 cursor-default" onclick="event.stopPropagation()">
                        <textarea id="chk-input-addr" class="checkout-inline-input w-full mb-3" rows="2" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€"></textarea>
                        <div class="flex gap-2">
                            <button onclick="saveCheckoutData('addr')" id="chk-save-addr" class="flex-1 bg-[#6ea44c] text-white py-2 rounded-lg text-xs font-bold flex justify-center items-center gap-1">å„²å­˜åœ°å€</button>
                            <button onclick="toggleCheckoutEdit('addr')" class="flex-1 border border-gray-300 text-gray-500 py-2 rounded-lg text-xs font-bold">å–æ¶ˆ</button>
                        </div>
                   </div>
                </div>
            </div>
        </section>

        <section class="space-y-4">
            <h4 class="text-xs font-bold brand-green uppercase tracking-widest border-b border-gray-100 pb-2">è¨‚å–®å‚™è¨»</h4>
            <textarea id="order-note" class="w-full p-4 rounded-2xl border border-gray-100 bg-gray-50/50 text-sm focus:ring-1 ring-[#6ea44c] outline-none resize-none" rows="2" placeholder="å¦‚æœ‰å…¶ä»–éœ€æ±‚è«‹å¡«å¯«..."></textarea>
        </section>

        <section class="bg-gray-50 p-6 rounded-3xl space-y-4">
            <div class="flex justify-between text-sm text-gray-500"><span>å•†å“å°è¨ˆ</span><span id="summary-subtotal" class="font-mono">NT$ 0</span></div>
            <div class="flex justify-between text-sm text-gray-500"><span>é‹è²» (<span id="summary-method" class="font-bold">æœªé¸</span>)</span><span id="summary-shipping" class="font-mono">NT$ 0</span></div>
            <div class="flex justify-between text-xl font-bold text-gray-800 pt-4 border-t border-gray-200"><span>ç¸½è¨ˆé‡‘é¡</span><span id="summary-total" class="brand-green font-mono">NT$ 0</span></div>
        </section>

        <div class="space-y-4 pt-4">
            <button onclick="handlePlaceOrder()" id="btn-submit-order" class="w-full bg-[#6ea44c] text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2">
                <span class="material-symbols-rounded">verified</span> ç¢ºèªé€å‡ºè¨‚å–®
            </button>
        </div>
    </div>
</div>

<div class="cart-floating-btn" onclick="openCart()">
    <span class="material-symbols-rounded text-3xl">shopping_bag</span>
    <span id="cart-count" class="absolute top-0 right-0 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white hidden">0</span>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyUq36i64Z-JGcERE_rZOdphVtVDX8L-lguc7eiUIdoAERqI1ZK8GWAL-HgbC75cuMHFg/exec"; 
    const siteBaseUrl = "{{ site.baseurl | default: '' }}";
    let cart = [];
    let globalProducts = [];
    let shippingRules = [];
    let selectedMethod = '';

    document.addEventListener('DOMContentLoaded', () => {
        initShop();
        const checkoutBtn = document.getElementById('trigger-checkout-btn');
        if(checkoutBtn) { checkoutBtn.addEventListener('click', openCheckout); }
    });

    async function initShop() {
        try {
            const res = await fetch(GAS_URL);
            const data = await res.json();
            if (!data || !data.products) {
                console.error("âŒ ç„¡æ³•å–å¾—å•†å“è³‡æ–™");
                document.getElementById('products-loader').innerText = "è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†";
                return;
            }
            globalProducts = data.products;
            shippingRules = (data.shipping_rules || []).map(r => ({
                ...r,
                method: (r.method && r.method.toString().includes('2025-')) ? '7-11' : r.method
            }));
            renderProducts(globalProducts);
            if(data.settings?.announcement) {
                document.getElementById('announcement-content').innerText = data.settings.announcement;
                document.getElementById('announcement-section').classList.remove('hidden');
            }
            document.getElementById('products-loader').classList.add('hidden');
            renderTopAuth();
        } catch (e) { 
            console.error("Init Error:", e);
            document.getElementById('products-loader').innerText = "é€£ç·šéŒ¯èª¤";
        }
    }

    // --- 1. ä½¿ç”¨ item-card.html å…§å®¹æ¸²æŸ“å•†å“ ---
    function renderProducts(products) {
        if (!products || !Array.isArray(products)) return;
        const container = document.getElementById('category-container');
        const grouped = products.reduce((acc, p) => {
            const cat = p.category || "ç²¾é¸é¸ç‰©";
            if (!acc[cat]) acc[cat] = [];
            acc[cat].push(p);
            return acc;
        }, {});

        container.innerHTML = Object.keys(grouped).map(cat => `
            <section class="space-y-6">
                <h3 class="text-xl font-bold border-l-4 border-[#6ea44c] pl-3">${cat}</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-10">
                    ${grouped[cat].map(p => {
                        const stock = parseInt(p.stock) || 999;
                        const isSoldOut = stock <= 0;
                        let img = p.image_url || "";
                        if (img && !img.startsWith('http')) img = siteBaseUrl + (img.startsWith('/') ? img : '/' + img);
                        
                        return `
                        <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden shadow-sm flex flex-col mobile-product-card transition hover:shadow-lg group">
                            
                            <div class="card-top-row md:contents">
                                ${img ? `
                                <div class="card-img-group md:order-first md:relative md:aspect-square md:w-full md:bg-gray-50 md:overflow-hidden">
                                    <img src="${img}" 
                                         class="w-full h-full object-cover transition duration-500 group-hover:scale-110 ${isSoldOut ? 'opacity-30 grayscale' : ''}" 
                                         alt="${p.product_name}">
                                    
                                    ${isSoldOut ? `
                                        <div class="absolute inset-0 flex items-center justify-center bg-black/5">
                                            <span class="bg-gray-800/90 text-white text-[10px] px-3 py-1.5 rounded-full font-bold backdrop-blur-sm">
                                                å·²å”®ç½„
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                                
                                <div class="card-info-group md:p-5 md:flex-1 md:flex md:flex-col">
                                    <h4 class="font-bold text-gray-800 mb-1 text-sm md:text-base line-clamp-1">
                                        ${p.product_name}
                                    </h4>
                                    
                                    <p class="text-gray-400 text-[11px] leading-relaxed mb-3 line-clamp-2 min-h-[32px]">
                                        ${p.special_notes || ''}
                                    </p>
                                    
                                    <div class="md:mt-auto md:mb-4">
                                        <span class="brand-green font-bold text-lg font-mono">
                                            NT$ ${p.price}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="card-bottom-row md:p-5 md:border-t md:flex md:gap-2">
                                <div class="qty-control">
                                    <button class="qty-btn" onclick="adjQty('${p.product_id}', -1)">-</button>
                                    <span id="iq-${p.product_id}" class="text-xs font-bold px-2 min-w-[20px] text-center">1</span>
                                    <button class="qty-btn" onclick="adjQty('${p.product_id}', 1)">+</button>
                                </div>
                                
                                <button onclick="addToCart('${p.product_id}')" 
                                        class="add-btn flex-1 py-3 bg-[#6ea44c] text-white rounded-xl text-xs font-bold transition active:scale-95 ${isSoldOut ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'hover:bg-[#5d8d41] shadow-md shadow-green-900/10'}" 
                                        ${isSoldOut ? 'disabled' : ''}>
                                    ${isSoldOut ? 'è£œè²¨ä¸­' : 'åŠ å…¥è³¼ç‰©è»Š'}
                                </button>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
            </section>
        `).join('');
    }

    // --- 2. åš´æ ¼é‹è²»é‚è¼¯ (å–æœ€è²´) ---
    function calculateFinalShipping(method, subtotal) {
        if (!method || !shippingRules || shippingRules.length === 0) return 0;
        
        const cartCats = [...new Set(cart.map(i => {
            const p = globalProducts.find(gp => gp.product_id === i.id);
            return p ? (p.category ? p.category.toString().trim() : 'default') : 'default';
        }))];
        
        let applicableRules = [];
        cartCats.forEach(cat => {
            let rule = shippingRules.find(r => r.method.toString().trim() === method && r.category.toString().trim() === cat);
            if (!rule) rule = shippingRules.find(r => r.method.toString().trim() === method && r.category.toLowerCase().trim() === 'default');
            if (rule) applicableRules.push(rule);
        });

        if (applicableRules.length === 0) return 0;
        const activeRule = applicableRules.reduce((prev, current) => (parseFloat(prev.base) > parseFloat(current.base)) ? prev : current);

        let fee = parseFloat(activeRule.base) || 0;
        const s = parseFloat(subtotal);
        if (activeRule.t3 && s >= parseFloat(activeRule.t3)) fee = parseFloat(activeRule.f3);
        else if (activeRule.t2 && s >= parseFloat(activeRule.t2)) fee = parseFloat(activeRule.f2);
        else if (activeRule.t1 && s >= parseFloat(activeRule.t1)) fee = parseFloat(activeRule.f1);
        
        return fee;
    }

    // --- è³¼ç‰©è»Š ---
    function adjQty(pid, delta) {
        const el = document.getElementById(`iq-${pid}`);
        let v = parseInt(el.innerText) + delta;
        if(v < 1) v = 1;
        el.innerText = v;
    }

    function addToCart(pid) {
        const p = globalProducts.find(x => x.product_id === pid);
        const qty = parseInt(document.getElementById(`iq-${pid}`).innerText);
        const inCart = cart.find(x => x.id === pid);
        const stock = parseInt(p.stock) || 999;
        if ((inCart ? inCart.qty : 0) + qty > stock) return alert(`åº«å­˜ä¸è¶³ï¼`);
        let fImg = p.image_url || "";
        if (fImg && !fImg.startsWith('http')) fImg = siteBaseUrl + (fImg.startsWith('/') ? fImg : '/' + fImg);
        if (inCart) inCart.qty += qty; else cart.push({ id: pid, name: p.product_name, price: p.price, qty: qty, img: fImg });
        updateCartUI();
        openCart();
    }

    // [UIä¿®æ”¹] è³¼ç‰©è»Šï¼šåƒåœ¾æ¡¶ icon æ”¹ç‚º å‰å‰ close icon
    function updateCartUI() {
        const count = cart.reduce((s, i) => s + i.qty, 0);
        const elCount = document.getElementById('cart-count');
        elCount.innerText = count;
        elCount.classList.toggle('hidden', count === 0);
        
        let total = 0;
        const container = document.getElementById('cart-items-container');
        if (cart.length === 0) {
            container.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-400"><span class="material-symbols-rounded text-4xl mb-2">shopping_basket</span><p>è³¼ç‰©è»Šç©ºç©ºçš„å–”</p></div>`;
        } else {
            container.innerHTML = cart.map((i, idx) => {
                total += i.price * i.qty;
                return `<div class="cart-item-row">
                    ${i.img ? `<img src="${i.img}" class="cart-item-img">` : ''}
                    <div class="flex-1 text-sm">
                        <div class="font-bold text-gray-800">${i.name}</div>
                        <div class="brand-green font-mono">NT$ ${i.price.toLocaleString()}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="cart-qty-control">
                            <div class="cart-qty-btn" onclick="updateCartQty(${idx}, -1)">-</div>
                            <div class="cart-qty-num">${i.qty}</div>
                            <div class="cart-qty-btn" onclick="updateCartQty(${idx}, 1)">+</div>
                        </div>
                        <button onclick="removeFromCart(${idx})" class="material-symbols-rounded text-gray-300 hover:text-red-500 text-xl">close</button>
                    </div>
                </div>`;
            }).join('');
        }
        document.getElementById('cart-total-price').innerText = "NT$ " + total.toLocaleString();
    }

    function updateCartQty(idx, delta) {
        const item = cart[idx];
        const prod = globalProducts.find(x => x.product_id === item.id);
        if (delta > 0 && item.qty + 1 > (parseInt(prod.stock) || 999)) return alert("å·²é”åº«å­˜ä¸Šé™");
        item.qty += delta;
        if (item.qty <= 0) cart.splice(idx, 1);
        updateCartUI();
    }
    function removeFromCart(idx) { cart.splice(idx, 1); updateCartUI(); }

    // --- çµå¸³æµç¨‹ ---
    function openCheckout() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        if(!u) { openLoginPanel(); return; }
        if(cart.length === 0) { alert("è³¼ç‰©è»Šç›®å‰æ˜¯ç©ºçš„"); return; }
        
        updateCheckoutDisplay(u);
        
        // å¡«å…¥ input é è¨­å€¼ (çµ¦ç·¨è¼¯æ¨¡å¼ç”¨)
        document.getElementById('chk-input-name').value = u.name || '';
        document.getElementById('chk-input-email').value = u.email || ''; // æ–°å¢ Email
        document.getElementById('chk-input-711').value = u.store_711 || '';
        document.getElementById('chk-input-711-note').value = u.store_711_note || '';
        document.getElementById('chk-input-fami').value = u.store_fami || '';
        document.getElementById('chk-input-fami-note').value = u.store_fami_note || '';
        document.getElementById('chk-input-addr').value = u.shipping_address || '';

        // éš±è—æ‰€æœ‰ç·¨è¼¯æ¡†
        document.querySelectorAll('[id^="checkout-edit-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('checkout-view-info').classList.remove('hidden');

        selectedMethod = '';
        renderShipMethodSelection();
        updateSummary();
        closeAllPanels();
        document.getElementById('checkout-panel').classList.add('open');
        document.getElementById('global-overlay').classList.add('open');
    }

    function updateCheckoutDisplay(u) {
        document.getElementById('checkout-info-name').innerText = u.name || 'æœªå¡«å¯«';
        document.getElementById('checkout-info-email').innerText = u.email || 'æœªå¡«å¯«'; // æ–°å¢ Email é¡¯ç¤º
        document.getElementById('checkout-info-phone').innerText = u.phone;
        document.getElementById('checkout-display-7-11').innerText = u.store_711 ? `${u.store_711} ${u.store_711_note||''}` : 'æœªè¨­å®š';
        document.getElementById('checkout-display-fami').innerText = u.store_fami ? `${u.store_fami} ${u.store_fami_note||''}` : 'æœªè¨­å®š';
        document.getElementById('checkout-display-addr').innerText = u.shipping_address || 'æœªè¨­å®š';
    }

    function selectShipMethod(id) {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const check = id === '7-11' ? u.store_711 : (id === 'fami' ? u.store_fami : u.shipping_address);
        if(!check) { 
            toggleCheckoutEdit(id === '7-11' ? '711' : (id === 'fami' ? 'fami' : 'addr'));
            return; 
        }
        selectedMethod = (id === 'fami') ? 'å…¨å®¶' : (id === 'addr' ? 'å®…é…' : '7-11');
        renderShipMethodSelection();
        updateSummary();
    }

    function renderShipMethodSelection() {
        document.querySelectorAll('.ship-opt-card').forEach(el => {
            el.classList.remove('border-[#6ea44c]', 'bg-brand-green-10');
            el.classList.add('border-gray-50');
        });
        let mapId = '';
        if(selectedMethod === '7-11') mapId = 'opt-7-11';
        else if(selectedMethod === 'å…¨å®¶') mapId = 'opt-fami';
        else if(selectedMethod === 'å®…é…') mapId = 'opt-addr';
        if(mapId) {
            const el = document.getElementById(mapId);
            el.classList.remove('border-gray-50');
            el.classList.add('border-[#6ea44c]', 'bg-[#6ea44c]/5');
        }
    }

    function updateSummary() {
        const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
        let ship = 0;
        if(selectedMethod) {
            ship = calculateFinalShipping(selectedMethod, subtotal);
            document.getElementById('summary-method').innerText = selectedMethod;
            document.getElementById('summary-shipping').innerText = `NT$ ${ship}`;
        } else {
            document.getElementById('summary-method').innerText = "æœªé¸";
            document.getElementById('summary-shipping').innerText = "NT$ 0";
        }
        document.getElementById('summary-subtotal').innerText = `NT$ ${subtotal.toLocaleString()}`;
        document.getElementById('summary-total').innerText = `NT$ ${(subtotal + ship).toLocaleString()}`;
    }

    // --- 3. çµå¸³é é¢å…§è¯ç·¨è¼¯ (Inline Editing) ---
    function toggleCheckoutEdit(section) {
        if(section === 'info') {
            const isEditing = document.getElementById('checkout-view-info').classList.contains('hidden');
            if(!isEditing) {
                document.getElementById('checkout-view-info').classList.add('hidden');
                document.getElementById('checkout-edit-info').classList.remove('hidden');
            } else {
                document.getElementById('checkout-view-info').classList.remove('hidden');
                document.getElementById('checkout-edit-info').classList.add('hidden');
            }
        } else {
            const editBlock = document.getElementById(`checkout-edit-${section}`);
            editBlock.classList.toggle('hidden');
        }
    }

    async function saveCheckoutData(section) {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const btn = document.getElementById(`chk-save-${section}`);
        const originalText = btn.innerHTML;
        
        let updates = {};
        if (section === 'info') {
            updates.name = document.getElementById('chk-input-name').value;
            updates.email = document.getElementById('chk-input-email').value; // å„²å­˜ Email
        } else if (section === '711') {
            const val = document.getElementById('chk-input-711').value.trim();
            if (!/^\d{6}$/.test(val)) return alert('åº—è™Ÿå¿…é ˆæ˜¯ 6 ä½æ•¸å­—');
            updates.store_711 = val;
            updates.store_711_note = document.getElementById('chk-input-711-note').value;
        } else if (section === 'fami') {
            const val = document.getElementById('chk-input-fami').value.trim();
            if (!/^\d{6}$/.test(val)) return alert('åº—è™Ÿå¿…é ˆæ˜¯ 6 ä½æ•¸å­—');
            updates.store_fami = val;
            updates.store_fami_note = document.getElementById('chk-input-fami-note').value;
        } else if (section === 'addr') {
            updates.shipping_address = document.getElementById('chk-input-addr').value;
        }

        btn.innerHTML = `<span class="material-symbols-rounded animate-spin-custom text-[10px]">refresh</span>`;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.disabled = true;

        const newData = { ...u, ...updates };
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'save', ...newData }) });
            const result = await res.json();
            if(result.success) {
                localStorage.setItem('keicha_v2_user', JSON.stringify(newData));
                updateCheckoutDisplay(newData);
                toggleCheckoutEdit(section);
                if(section === '711') selectShipMethod('7-11');
                else if(section === 'fami') selectShipMethod('fami');
                else if(section === 'addr') selectShipMethod('addr');
                renderTopAuth();
            }
        } catch(e) { alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"); }
        btn.innerHTML = originalText;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.disabled = false;
    }

    // --- 4. é€å‡ºè¨‚å–® (Loading & ç¦ç”¨) ---
    async function handlePlaceOrder() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const line = document.getElementById('order-line-name').value.trim();
        
        // å¿…å¡«æª¢æŸ¥
        if(!u.name) return alert("è«‹å¡«å¯«æ”¶ä»¶äººå§“å");
        if(!u.email) return alert("è«‹å¡«å¯«é›»å­ä¿¡ç®±");
        if(!selectedMethod) return alert("è«‹é¸æ“‡æ”¶ä»¶æ–¹å¼");
        if(!line) return alert("è«‹å¡«å¯« LINE åç¨±ä»¥ä¾¿è¯ç¹«");

        const btn = document.getElementById('btn-submit-order');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = `<span class="material-symbols-rounded animate-spin-custom">refresh</span> å‚³é€è¨‚å–®ä¸­...`;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.disabled = true;

        const subtotal = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
        const ship = calculateFinalShipping(selectedMethod, subtotal);
        
        const payload = {
            action: 'checkout',
            name: u.name,
            phone: u.phone,
            email: u.email, // å‚³é€ Email
            store: selectedMethod === 'å®…é…' ? u.shipping_address : (selectedMethod === '7-11' ? u.store_711 : u.store_fami),
            temp: "å¸¸æº«",
            items: cart.map(i => `${i.name}x${i.qty}`).join(', '),
            subtotal: subtotal,
            shipping: ship,
            date: new Date().toLocaleString('zh-TW'),
            note: document.getElementById('order-note').value,
            line_name: line,
            logistics: selectedMethod
        };

        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            if(result.success) {
                alert("ä¸‹å–®æˆåŠŸï¼æˆ‘å€‘æœƒç›¡å¿«èˆ‡æ‚¨è¯ç¹«ã€‚");
                cart = []; updateCartUI(); closeAllPanels();
            }
        } catch(e) { alert("ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); }
        
        btn.innerHTML = originalText;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.disabled = false;
    }

    // --- æœƒå“¡ç³»çµ± (User Panel é‚è¼¯å·²æ¢å¾©) ---
    // [UIä¿®æ”¹] æŒ‰éˆ•æ–‡å­—ï¼šè¼‰å…¥å¾Œé‚„åŸç‚ºã€Œä¸‹ä¸€æ­¥ã€
    function handleQuickLogin() {
        const phone = document.getElementById('login-phone').value.trim();
        if(!/^09\d{8}$/.test(phone)) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„ 09 é–‹é ­ 10 ç¢¼é›»è©±");
        const icon = document.getElementById('login-icon');
        const text = document.getElementById('login-text');
        icon.classList.add('animate-spin'); text.innerText = "é©—è­‰ä¸­...";
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'login', phone }) })
            .then(res => res.json()).then(res => {
                if(res.success) { localStorage.setItem('keicha_v2_user', JSON.stringify(res.data)); renderTopAuth(); closeAllPanels(); }
            }).finally(() => { icon.classList.remove('animate-spin'); text.innerText = "ä¸‹ä¸€æ­¥"; });
    }

    function renderUserFields() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        if(!u) return;
        document.getElementById('display-user-phone').innerText = u.phone;
        document.getElementById('text-name').innerText = u.name || 'æœªå¡«å¯«';
        document.getElementById('upd-name').value = u.name || '';
        document.getElementById('text-email').innerText = u.email || 'æœªå¡«å¯«';
        document.getElementById('upd-email').value = u.email || '';
        document.getElementById('display-711').innerText = u.store_711 ? `${u.store_711} ${u.store_711_note||''}` : 'å°šæœªè¨­å®š';
        document.getElementById('upd-711').value = u.store_711 || '';
        document.getElementById('upd-711-note').value = u.store_711_note || '';
        document.getElementById('display-fami').innerText = u.store_fami ? `${u.store_fami} ${u.store_fami_note||''}` : 'å°šæœªè¨­å®š';
        document.getElementById('upd-fami').value = u.store_fami || '';
        document.getElementById('upd-fami-note').value = u.store_fami_note || '';
        document.getElementById('display-addr').innerText = u.shipping_address || 'å°šæœªè¨­å®š';
        document.getElementById('upd-addr').value = u.shipping_address || '';
    }

    function toggleEdit(section) {
        if (section === 'info') {
            const isEditing = !document.getElementById('text-name').classList.contains('hidden');
            if (isEditing) {
                document.getElementById('text-name').classList.add('hidden');
                document.getElementById('upd-name').classList.remove('hidden');
                document.getElementById('text-email').classList.add('hidden');
                document.getElementById('upd-email').classList.remove('hidden');
                document.getElementById('info-edit-actions').classList.remove('hidden');
            } else {
                renderUserFields();
                document.getElementById('text-name').classList.remove('hidden');
                document.getElementById('upd-name').classList.add('hidden');
                document.getElementById('text-email').classList.remove('hidden');
                document.getElementById('upd-email').classList.add('hidden');
                document.getElementById('info-edit-actions').classList.add('hidden');
            }
        } else {
            const disp = document.getElementById(`display-${section}`);
            const edit = document.getElementById(`edit-${section}`);
            const btnQuery = document.getElementById(`btn-${section}-query`);
            if (edit.classList.contains('hidden')) {
                edit.classList.remove('hidden');
                disp.classList.add('hidden');
                if(btnQuery) btnQuery.classList.remove('hidden');
            } else {
                edit.classList.add('hidden');
                disp.classList.remove('hidden');
                if(btnQuery) btnQuery.classList.add('hidden');
                renderUserFields();
            }
        }
    }

    async function saveFullUser(section) {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        const btn = document.getElementById(`save-btn-${section}`);
        const originalText = btn.innerHTML;
        
        let updates = {};
        if (section === 'info') {
            updates.name = document.getElementById('upd-name').value;
            updates.email = document.getElementById('upd-email').value;
        } else if (section === '711') {
            const val = document.getElementById('upd-711').value.trim();
            if (!/^\d{6}$/.test(val)) return alert('åº—è™Ÿå¿…é ˆæ˜¯ 6 ä½æ•¸å­—');
            updates.store_711 = val;
            updates.store_711_note = document.getElementById('upd-711-note').value;
        } else if (section === 'fami') {
            const val = document.getElementById('upd-fami').value.trim();
            if (!/^\d{6}$/.test(val)) return alert('åº—è™Ÿå¿…é ˆæ˜¯ 6 ä½æ•¸å­—');
            updates.store_fami = val;
            updates.store_fami_note = document.getElementById('upd-fami-note').value;
        } else if (section === 'addr') {
            updates.shipping_address = document.getElementById('upd-addr').value;
        }

        btn.innerHTML = `<span class="material-symbols-rounded animate-spin-custom">refresh</span>`;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        btn.disabled = true;

        const newData = { ...u, ...updates };
        try {
            const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'save', ...newData }) });
            const result = await res.json();
            if(result.success) {
                localStorage.setItem('keicha_v2_user', JSON.stringify(newData));
                renderUserFields();
                toggleEdit(section);
                renderTopAuth();
            }
        } catch(e) { alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"); }
        btn.innerHTML = originalText;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
        btn.disabled = false;
    }

    function handleLogout() {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) { localStorage.removeItem('keicha_v2_user'); location.reload(); }
    }

    function renderTopAuth() {
        const u = JSON.parse(localStorage.getItem('keicha_v2_user'));
        document.getElementById('top-auth-zone').innerHTML = u ? `<button onclick="openUserPanel()" class="flex items-center gap-1 brand-green font-bold text-sm"><span class="material-symbols-rounded text-lg">account_circle</span> ${u.name || u.phone}</button>` : `<button onclick="openLoginPanel()" class="text-gray-400 text-sm font-bold">ç™»å…¥/è¨»å†Š</button>`;
    }

    function openLoginPanel() { closeAllPanels(); document.getElementById('login-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openUserPanel() { renderUserFields(); document.getElementById('user-panel').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function openCart() { document.getElementById('cart-sidebar').classList.add('open'); document.getElementById('global-overlay').classList.add('open'); }
    function closeAllPanels() { document.querySelectorAll('.side-panel, .overlay').forEach(p => p.classList.remove('open')); }
    
    // å…¨åŸŸç¶å®š
    window.openCheckout = openCheckout;
    window.closeAllPanels = closeAllPanels;
    window.addToCart = addToCart;
    window.adjQty = adjQty;
    window.updateCartQty = updateCartQty;
    window.removeFromCart = removeFromCart;
    window.openCart = openCart;
    window.handleQuickLogin = handleQuickLogin;
    window.handlePlaceOrder = handlePlaceOrder;
    window.openLoginPanel = openLoginPanel;
    window.openUserPanel = openUserPanel;
    window.toggleEdit = toggleEdit; // For user-panel
    window.saveFullUser = saveFullUser; // For user-panel
    window.selectShipMethod = selectShipMethod;
    window.handleLogout = handleLogout;
    window.toggleCheckoutEdit = toggleCheckoutEdit;
    window.saveCheckoutData = saveCheckoutData;
</script>
